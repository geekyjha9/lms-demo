<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="courseDetail.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="nav">
      <input type="checkbox" id="nav-check" />
      <div class="nav-header">
        <div class="nav-title">Shunya.Ek Learning</div>
      </div>
      <div class="nav-btn">
        <label for="nav-check">
          <i class="ri-menu-line" style="font-size: 24px"></i>
        </label>
      </div>

      <div class="nav-links">
        <a href="/">Home</a>
        <a href="#courses">Courses</a>
        <a href="#review">Reviews</a>
        <a id="logoutLink" href="#">LogOut</a>
      </div>
    </nav>
    <!-- <main class="container_hero">
        <div class="main_container">
          <div class="heading_ele">
            <h1>UX Design with Leo Darvice</h1>
          </div>
          <div class="para">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam eu
            turpis molestie, dictum est a, mattis tellus. Sed dignissim, metus nec
            fringilla accumsan, risus sem sollicitudin lacus, ut interdum tellus
            elit sed risus. Maecenas eget condimentum velit, sit amet feugiat
            lectus. Class aptent taciti sociosqu ad litora torquent per conubia
            nostra, per inceptos himenaeos. Praesent auctor purus luctus enim
            egestas,
          </div>
  
          <button class="enroll">
            <div class="enroll_txt">Enroll</div>
            <div class="next_batch">Next Batch April 11th</div>
          </button>
        </div>
  
        <div class="rectangle-109">
          <img src="images/team1.jpg" alt="Rectangle" class="ux_image" />
        </div>
      </main> -->

    <main class="container_hero" id="courseDetailContainer">
      <!-- Dynamic content will be inserted here -->
    </main>

    <div class="main_view">
      <div class="review">
        <div class="left_element">
          <div class="reviews">
            <div class="main_review">
              <div class="star">
                <img src="images/star.png" alt="star" class="star_image" />
              </div>

              <div class="rating">
                <div class="first">4.7/5.0</div>
                <div class="second">204 Reviews</div>
              </div>
            </div>
          </div>
          <div class="course_duration">
            <div class="course_first">2 Months</div>
            <div class="course_second">2 Hours per Week</div>
          </div>
          <div class="course_level">
            <div class="level_first">Intermediate Level</div>
            <div class="level_second">
              Some Basic <br />
              Knowledge Required
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="about_container">
      <div class="about_course">
        <div class="about_headin">About the Course</div>
        <div class="about_para">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam eu
          turpis molestie, dictum est a, mattis tellus. Sed dignissim, metus nec
          fringilla accumsan, risus sem sollicitudin lacus, ut interdum tellus
          elit sed risus. Maecenas eg Lorem ipsum, dolor sit amet consectetur
          adipisicing elit. Autem eum fuga illo doloribus laborum soluta facere
          perspiciatis maiores assumenda itaque vero, vel harum! In voluptates
          nulla sit eaque perferendis dolores veritatis, asperiores quibusdam
          officia nostrum autem atque, sunt natus error vero ipsum consequatur
          at? Qui aliquid consequatur cupiditate commodi expedita.
        </div>
      </div>
      <div class="skills">
        <div class="skills_heading">Skills you will Gain</div>
        <div class="skills_lists">
          <div class="skill hw_skill2">Lorem Ipsum</div>
          <div class="skill hw_skill2">Lorem Ipsum</div>
          <div class="skill hw_skill2">Lorem Ipsum</div>
          <div class="skill hw_skill1">Lorem Ipsum</div>
          <div class="skill hw_skill3">Lorem Ipsum</div>
          <div class="skill hw_skill3">Lorem Ipsum</div>
          <div class="skill hw_skill2">Lorem Ipsum</div>
          <div class="skill hw_skill1">Lorem Ipsum</div>
          <div class="skill hw_skill1">Lorem Ipsum</div>
          <div class="skill">Lorem Ipsum</div>
          <div class="skill">Lorem Ipsum</div>
          <div class="skill">Lorem Ipsum</div>
        </div>
      </div>
    </div>
    <div class="course_head">Course Structure</div>
    <div class="course_structure">
      <div class="course_1">
        <div class="course_sn1">
          <div class="course_internal">Course</div>
          <div class="sn_number">1</div>
        </div>
        <div class="course_paragrap">
          Torem ipsum dolor sit amet, consectetur adipiscing elit. Nunc
          vulputate libero et velit interdum, ac aliquet odio mattis. Class
          aptent taciti sociosqu ad litora torquent per conubia nostra, per
          inceptos himenaeos.
        </div>
        <div class="duration">
          <div class="duration_heading">Duration</div>
          <div class="duration_time">30 <span class="hrs">Hrs</span></div>
        </div>
        <div class="test">
          <div class="test_heading">Tests</div>
          <div class="test_num">4</div>
        </div>
      </div>

      <div class="course_1">
        <div class="course_sn1">
          <div class="course_internal">Course</div>
          <div class="sn_number">2</div>
        </div>
        <div class="course_paragrap">
          Torem ipsum dolor sit amet, consectetur adipiscing elit. Nunc
          vulputate libero et velit interdum, ac aliquet odio mattis. Class
          aptent taciti sociosqu ad litora torquent per conubia nostra, per
          inceptos himenaeos.
        </div>
        <div class="duration">
          <div class="duration_heading">Duration</div>
          <div class="duration_time">30 <span class="hrs">Hrs</span></div>
        </div>
        <div class="test">
          <div class="test_heading">Tests</div>
          <div class="test_num">4</div>
        </div>
      </div>

      <div class="course_1">
        <div class="course_sn1">
          <div class="course_internal">Course</div>
          <div class="sn_number">3</div>
        </div>
        <div class="course_paragrap">
          Torem ipsum dolor sit amet, consectetur adipiscing elit. Nunc
          vulputate libero et velit interdum, ac aliquet odio mattis. Class
          aptent taciti sociosqu ad litora torquent per conubia nostra, per
          inceptos himenaeos.
        </div>
        <div class="duration">
          <div class="duration_heading">Duration</div>
          <div class="duration_time">30 <span class="hrs">Hrs</span></div>
        </div>
        <div class="test">
          <div class="test_heading">Tests</div>
          <div class="test_num">4</div>
        </div>
      </div>
    </div>
    <div class="downword_navigation">
      <div class="navigation_background">
        <div class="downword_image">
          <img
            src="images/Vector18.png"
            alt="downword_arrow"
            class="navigation_image"
          />
        </div>
      </div>
    </div>

    <div class="instructor">
      <div class="about_instructor">
        <div class="heading_instru">Add Your Experience</div>
        <div class="para_instru">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam eu
          turpis molestie, dictum est a, mattis tellus. Sed dignissim, metus nec
          fringilla accumsan, risus sem sollicitudin lacus,
        </div>
        <div class="instru_rating">Give Rating to course</div>
        <div class="main_star">
          <div class="star">
            <img src="Images/Star 7.svg" alt="star_img" class="star_image" />
          </div>
          <div class="star">
            <img src="Images/Star 7.svg" alt="star_img" class="star_image" />
          </div>
          <div class="star">
            <img src="Images/Star 7.svg" alt="star_img" class="star_image" />
          </div>
          <div class="star">
            <img src="Images/Star 7.svg" alt="star_img" class="star_image" />
          </div>
          <div class="star">
            <img src="Images/Star 7.svg" alt="star_img" class="star_image" />
          </div>
        </div>
        <form>
          <input type="text" placeholder="Share your personal experience" />
          <button type="submit">Submit</button>
        </form>
      </div>
      <div class="instructor_image">
        <img
          style="max-width: 502px; object-fit: cover"
          src="images/team1.jpg"
          class="instru_image"
        />
      </div>
    </div>
    <div class="comment-list">
      <div class="comment-section">
        <div class="description">
          <div class="video-flex">
            <div class="video-owner-thumb">
              <img
                src="https://yt3.ggpht.com/-nkIiVuXKTqQ/AAAAAAAAAAI/AAAAAAAAAAA/dkx8RZJxh1w/s48-c-k-no-mo-rj-c0xffffff/photo.jpg"
                alt=""
              />
            </div>
            <textarea name="comment" id="comment"></textarea>
            <button>Comment</button>
          </div>
        </div>
      </div>
      <div class="description">
        <div class="description-item">
          <div class="video-owner-thumb">
            <img src="images/team2.jpg" alt="" />
          </div>

          <div class="video-channel-details">
            <p class="channel-name">Ariana Grande</p>
            <p class="date">Published on Mar 15, 2013</p>
            <div class="comment-text">
              <p>
                so cool to watch a video where someone gets straight into it,
                doesn't waffle on for 1-2 minutes about nothing and explains the
                process clearly. good job!
              </p>
            </div>
            <div class="social-buttons">
              <ul class="navgroup social-icons">
                <li><i class="ri-thumb-up-line"></i>58</li>
                <li><i class="ri-thumb-down-line"></i>21</li>
                <li><i class="ri-reply-line"></i>reply</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="description-item">
          <div class="video-owner-thumb">
            <img src="images/team2.jpg" alt="" />
          </div>

          <div class="video-channel-details">
            <p class="channel-name">Ariana Grande</p>
            <p class="date">Published on Mar 15, 2013</p>
            <div class="comment-text">
              <p>
                so cool to watch a video where someone gets straight into it,
                doesn't waffle on for 1-2 minutes about nothing and explains the
                process clearly. good job!
              </p>
            </div>
            <div class="social-buttons">
              <ul class="navgroup social-icons">
                <li><i class="ri-thumb-up-line"></i>58</li>
                <li><i class="ri-thumb-down-line"></i>21</li>
                <li><i class="ri-reply-line"></i>reply</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="description-item">
          <div class="video-owner-thumb">
            <img src="images/team2.jpg" alt="" />
          </div>

          <div class="video-channel-details">
            <p class="channel-name">Ariana Grande</p>
            <p class="date">Published on Mar 15, 2013</p>
            <div class="comment-text">
              <p>
                so cool to watch a video where someone gets straight into it,
                doesn't waffle on for 1-2 minutes about nothing and explains the
                process clearly. good job!
              </p>
            </div>
            <div class="social-buttons">
              <ul class="navgroup social-icons">
                <li><i class="ri-thumb-up-line"></i>58</li>
                <li><i class="ri-thumb-down-line"></i>21</li>
                <li><i class="ri-reply-line"></i>reply</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="description-item">
          <div class="video-owner-thumb">
            <img src="images/team2.jpg" alt="" />
          </div>

          <div class="video-channel-details">
            <p class="channel-name">Ariana Grande</p>
            <p class="date">Published on Mar 15, 2013</p>
            <div class="comment-text">
              <p>
                so cool to watch a video where someone gets straight into it,
                doesn't waffle on for 1-2 minutes about nothing and explains the
                process clearly. good job!
              </p>
            </div>
            <div class="social-buttons">
              <ul class="navgroup social-icons">
                <li><i class="ri-thumb-up-line"></i>58</li>
                <li><i class="ri-thumb-down-line"></i>21</li>
                <li><i class="ri-reply-line"></i>reply</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="description-item">
          <div class="video-owner-thumb">
            <img src="images/team2.jpg" alt="" />
          </div>

          <div class="video-channel-details">
            <p class="channel-name">Ariana Grande</p>
            <p class="date">Published on Mar 15, 2013</p>
            <div class="comment-text">
              <p>
                so cool to watch a video where someone gets straight into it,
                doesn't waffle on for 1-2 minutes about nothing and explains the
                process clearly. good job!
              </p>
            </div>
            <div class="social-buttons">
              <ul class="navgroup social-icons">
                <li><i class="ri-thumb-up-line"></i>58</li>
                <li><i class="ri-thumb-down-line"></i>21</li>
                <li><i class="ri-reply-line"></i>reply</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="description-item">
          <div class="video-owner-thumb">
            <img src="images/team2.jpg" alt="" />
          </div>

          <div class="video-channel-details">
            <p class="channel-name">Ariana Grande</p>
            <p class="date">Published on Mar 15, 2013</p>
            <div class="comment-text">
              <p>
                so cool to watch a video where someone gets straight into it,
                doesn't waffle on for 1-2 minutes about nothing and explains the
                process clearly. good job!
              </p>
            </div>
            <div class="social-buttons">
              <ul class="navgroup social-icons">
                <li><i class="ri-thumb-up-line"></i>58</li>
                <li><i class="ri-thumb-down-line"></i>21</li>
                <li><i class="ri-reply-line"></i>reply</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- <script src="script.js"></script> -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Extract course ID from the URL parameters
        const urlParams = new URLSearchParams(window.location.search);

        // Get the courseId from the URL parameters
        const courseIdString = urlParams.get("courseId");
        const courseId = parseInt(courseIdString, 10);

        // console.log("courseId:", courseId, "Type:", typeof courseId);

        // Check if courseId is undefined or null
        if (courseId === undefined || courseId === null) {
          console.error("Error: courseId is undefined or null");
        } else {
          console.log("Course ID is defined:", courseId);
        }

        // Fetch course details based on the courseId
        fetchCourseDetails(courseId)
          .then((courseDetails) => {
            // Populate the HTML with course details
            populateCourseDetails(courseDetails);

            const enrollButton = document.getElementById("enroll-course");

            if (enrollButton) {
              // Add a click event listener to the Enroll button
              enrollButton.addEventListener("click", function () {
                // Retrieve the studentId from sessionStorage
                const studentId = sessionStorage.getItem("token");

                // const studentId = 1;
                console.log(
                  "Retrieved studentId from sessionStorage:",
                  studentId
                );
                // Check if studentId is valid
                if (!isNaN(studentId) && studentId > 0) {
                  // Call the enrollInCourse function with courseId and studentId
                  enrollInCourse(courseId, studentId);
                } else {
                  console.error("Error: Invalid studentId");

                  window.location.href = "userManagement.html";
                }
              });
            } else {
              console.error("Error: Enroll button not found");
            }
          })
          .catch((error) => {
            console.error("Error fetching course details:", error);
          });

        const logoutLink = document.getElementById("logoutLink");

        if (logoutLink) {
          logoutLink.addEventListener("click", function (event) {
            event.preventDefault(); // Prevent the default behavior of the link

            // Clear the sessionStorage
            sessionStorage.clear();

            // Redirect to the login page
            window.location.href = "userManagement.html"; // Change "login.html" to your actual login page
          });
        }
      });

      function fetchCourseDetails(courseId) {
        // const coursId = 1;
        // const coursId = courseId;

        console.log("CourseId from fetchCourseDetails:  ", courseId);
        return new Promise((resolve, reject) => {
          openDatabase()
            .then((db) => {
              const transaction = db.transaction(["courses"], "readonly");
              const store = transaction.objectStore("courses");
              const getRequest = store.get(courseId);

              getRequest.onsuccess = function (event) {
                const course = event.target.result;
                console.log("getRequest.onsuccess - course:", course);
                resolve(course);
              };

              getRequest.onerror = function (event) {
                console.error(
                  "getRequest.onerror - error:",
                  event.target.error
                );
                reject(event.target.error);
              };
            })
            .catch((error) => {
              console.error("openDatabase.catch - error:", error);
              reject(error);
            });
        });
      }

      function openDatabase() {
        return new Promise((resolve, reject) => {
          const request = window.indexedDB.open("LearningManagementDB", 1);

          request.onsuccess = function (event) {
            const db = event.target.result;
            resolve(db);
          };

          request.onerror = function (event) {
            reject(event.target.error);
          };
        });
      }

      function populateCourseDetails(courseDetails) {
        const courseDetailContainer = document.getElementById(
          "courseDetailContainer"
        );

        // Check if courseDetails is defined before accessing its properties
        if (courseDetails) {
          // Create HTML elements dynamically based on courseDetails
          const mainContainer = document.createElement("div");
          mainContainer.classList.add("main_container");

          const headingElement = document.createElement("div");
          headingElement.classList.add("heading_ele");
          headingElement.innerHTML = `<h1>${courseDetails.name}</h1>`;

          const paraElement = document.createElement("div");
          paraElement.classList.add("para");
          paraElement.textContent = courseDetails.description;

          const enrollButton = document.createElement("button");
          enrollButton.classList.add("enroll");
          enrollButton.innerHTML = `
      <div class="enroll_txt" id="enroll-course">Enroll</div>
      <div class="next_batch">${courseDetails.nextBatch}</div>
    `;

          mainContainer.appendChild(headingElement);
          mainContainer.appendChild(paraElement);
          mainContainer.appendChild(enrollButton);

          const rectangleElement = document.createElement("div");
          rectangleElement.classList.add("rectangle-109");
          const uxImage = document.createElement("img");
          uxImage.src =
            courseDetails.bannerUrl != undefined
              ? courseDetails.bannerUrl
              : "images/team1.jpg";
          uxImage.alt = "Course Image";
          uxImage.classList.add("ux_image");
          rectangleElement.appendChild(uxImage);

          courseDetailContainer.appendChild(mainContainer);
          courseDetailContainer.appendChild(rectangleElement);
        } else {
          console.error("Course details not found for courseId:", courseId);
        }
      }

      function enrollInCourse(courseId, studentId) {
        openDatabase()
          .then((db) => {
            const enrollmentTransaction = db.transaction(
              ["enrollments"],
              "readwrite"
            );
            const enrollmentStore =
              enrollmentTransaction.objectStore("enrollments");

            // Fetch all enrollments for the student
            const index = enrollmentStore.index("studentId");
            const getAllRequest = index.getAll(studentId);

            getAllRequest.onsuccess = function () {
              const studentEnrollments = getAllRequest.result;

              // Check if the course is already enrolled
              const isEnrolled = studentEnrollments.some(
                (enrollment) => enrollment.courseId === courseId
              );

              if (!isEnrolled) {
                // Student is not enrolled in the course, proceed with enrollment
                const enrollment = {
                  studentId: studentId,
                  courseId: courseId,
                };

                const addEnrollmentRequest = enrollmentStore.add(enrollment);

                addEnrollmentRequest.onsuccess = function () {
                  console.log("Enrollment added successfully!");

                  // Update student's enrolledCourses field
                  updateStudentEnrollments(studentId, courseId);
                };

                addEnrollmentRequest.onerror = function () {
                  console.error(
                    "Error adding enrollment:",
                    addEnrollmentRequest.error
                  );
                };
              } else {
                console.log("Student is already enrolled in this course.");
              }
            };

            getAllRequest.onerror = function () {
              console.error("Error fetching enrollments:", getAllRequest.error);
            };
          })
          .catch((error) => {
            console.error("openDatabase.catch - error:", error);
          });
      }

      function updateStudentEnrollments(studentId, courseId) {
        const stId = parseInt(studentId, 10);

        openDatabase()
          .then((db) => {
            const studentTransaction = db.transaction(
              ["students"],
              "readwrite"
            );
            const studentStore = studentTransaction.objectStore("students");

            // Get the student by ID
            const getStudentRequest = studentStore.get(stId);

            getStudentRequest.onsuccess = function (event) {
              const student = event.target.result;

              // Check if student exists
              if (student) {
                // Initialize enrolledCourses if it doesn't exist
                if (!student.enrolledCourses) {
                  student.enrolledCourses = [];
                }

                // Check if the course is not already enrolled
                if (!student.enrolledCourses.includes(courseId)) {
                  // Add courseId to the enrolledCourses array
                  student.enrolledCourses.push(courseId);

                  // Update the student in the object store
                  const updateStudentRequest = studentStore.put(student);

                  updateStudentRequest.onsuccess = function () {
                    console.log(
                      "Student updated successfully with enrolledCourses:",
                      student.enrolledCourses
                    );
                  };

                  updateStudentRequest.onerror = function () {
                    console.error(
                      "Error updating student:",
                      updateStudentRequest.error
                    );
                  };
                } else {
                  console.log("Student is already enrolled in this course.");
                }
              } else {
                console.error("Student not found with ID:", studentId);
              }
            };

            getStudentRequest.onerror = function () {
              console.error("Error fetching student:", getStudentRequest.error);
            };
          })
          .catch((error) => {
            console.error("openDatabase.catch - error:", error);
          });
      }
    </script>
  </body>
</html>
